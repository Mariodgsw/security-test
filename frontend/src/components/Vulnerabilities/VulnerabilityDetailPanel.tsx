import React from 'react';
import { motion } from 'framer-motion';
import { RiShieldLine, RiAlertLine, RiTimeLine } from 'react-icons/ri';
import { Line, Bar } from 'react-chartjs-2';
import {
  Chart as ChartJS,
  CategoryScale,
  LinearScale,
  PointElement,
  LineElement,
  BarElement,
  Title,
  Tooltip,
  Legend
} from 'chart.js';

ChartJS.register(
  CategoryScale,
  LinearScale,
  PointElement,
  LineElement,
  BarElement,
  Title,
  Tooltip,
  Legend
);

interface VulnerabilityCount {
  critical: number;
  high: number;
  medium: number;
  low: number;
  info: number;
}

interface VulnerabilityDetailProps {
  active: VulnerabilityCount;
  passive: VulnerabilityCount;
  onClose: () => void;
}

const VulnerabilityDetailPanel: React.FC<VulnerabilityDetailProps> = ({
  active,
  passive,
  onClose
}) => {
  // Calculate total vulnerabilities by severity
  const totalVulnerabilities = {
    critical: active.critical + passive.critical,
    high: active.high + passive.high,
    medium: active.medium + passive.medium,
    low: active.low + passive.low,
    info: active.info + passive.info
  };

  // Calculate resolution percentages
  const getResolutionPercentage = (severity: keyof typeof active) => {
    const total = active[severity] + passive[severity];
    return total === 0 ? 0 : (active[severity] / total) * 100;
  };

  // Prepare data for comparison chart
  const comparisonData = {
    labels: ['Critical', 'High', 'Medium', 'Low', 'Info'],
    datasets: [
      {
        label: 'Active',
        data: Object.values(active),
        backgroundColor: 'rgba(239, 68, 68, 0.5)', // security-critical-bg
        borderColor: 'rgb(239, 68, 68)',           // security-critical-text
        borderWidth: 1
      },
      {
        label: 'Passive',
        data: Object.values(passive),
        backgroundColor: 'rgba(59, 130, 246, 0.5)', // ui-accent-primary with alpha
        borderColor: 'rgb(59, 130, 246)',           // ui-accent-primary
        borderWidth: 1
      }
    ]
  };

  return (
    <div className="bg-ui-background rounded-lg shadow-xl p-6 max-w-6xl w-full mx-4">
      {/* Header */}
      <div className="flex justify-between items-center mb-8">
        <div className="flex items-center">
          <RiShieldLine className="text-3xl text-ui-accent-primary mr-3" />
          <h2 className="text-2xl font-bold text-ui-text-primary">Vulnerability Analysis</h2>
        </div>
        <button
          onClick={onClose}
          className="text-ui-text-tertiary hover:text-ui-text-primary transition-colors"
        >
          <RiTimeLine className="text-2xl" />
        </button>
      </div>

      {/* Summary Cards */}
      <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
        <div className="bg-security-critical-bg rounded-lg p-4">
          <div className="flex items-center justify-between">
            <div>
              <p className="text-security-critical-text font-semibold">Critical & High</p>
              <h3 className="text-2xl font-bold text-security-critical-text">
                {totalVulnerabilities.critical + totalVulnerabilities.high}
              </h3>
            </div>
            <RiAlertLine className="text-3xl text-security-critical-text" />
          </div>
          <div className="mt-2">
            <p className="text-sm text-security-critical-text">
              Active: {active.critical + active.high}
            </p>
            <p className="text-sm text-security-critical-text">
              Passive: {passive.critical + passive.high}
            </p>
          </div>
        </div>

        <div className="bg-security-warning-bg rounded-lg p-4">
          <div className="flex items-center justify-between">
            <div>
              <p className="text-security-warning-text font-semibold">Medium</p>
              <h3 className="text-2xl font-bold text-security-warning-text">
                {totalVulnerabilities.medium}
              </h3>
            </div>
            <RiAlertLine className="text-3xl text-security-warning-text" />
          </div>
          <div className="mt-2">
            <p className="text-sm text-security-warning-text">
              Active: {active.medium}
            </p>
            <p className="text-sm text-security-warning-text">
              Passive: {passive.medium}
            </p>
          </div>
        </div>

        <div className="bg-security-info-bg rounded-lg p-4">
          <div className="flex items-center justify-between">
            <div>
              <p className="text-security-info-text font-semibold">Low & Info</p>
              <h3 className="text-2xl font-bold text-security-info-text">
                {totalVulnerabilities.low + totalVulnerabilities.info}
              </h3>
            </div>
            <RiAlertLine className="text-3xl text-security-info-text" />
          </div>
          <div className="mt-2">
            <p className="text-sm text-security-info-text">
              Active: {active.low + active.info}
            </p>
            <p className="text-sm text-security-info-text">
              Passive: {passive.low + passive.info}
            </p>
          </div>
        </div>
      </div>

      {/* Comparison Chart */}
      <div className="bg-ui-backgroundAlt rounded-lg p-6 mb-8">
        <h3 className="text-xl font-semibold text-ui-text-primary mb-4">Active vs Passive Vulnerabilities</h3>
        <div className="h-80">
          <Bar
            data={comparisonData}
            options={{
              responsive: true,
              maintainAspectRatio: false,
              scales: {
                y: {
                  beginAtZero: true,
                  grid: {
                    color: 'rgba(255, 255, 255, 0.1)'
                  },
                  ticks: {
                    color: '#94a3b8' // text-ui-text-tertiary
                  }
                },
                x: {
                  grid: {
                    color: 'rgba(255, 255, 255, 0.1)'
                  },
                  ticks: {
                    color: '#94a3b8' // text-ui-text-tertiary
                  }
                }
              },
              plugins: {
                legend: {
                  position: 'top',
                  labels: {
                    color: '#94a3b8' // text-ui-text-tertiary
                  }
                }
              }
            }}
          />
        </div>
      </div>

      {/* Resolution Progress */}
      <div className="space-y-6">
        <h3 className="text-xl font-semibold text-ui-text-primary">Resolution Progress</h3>
        {Object.keys(active).map((severity) => (
          <div key={severity} className="bg-ui-backgroundAlt rounded-lg p-4 border border-ui-border">
            <div className="flex justify-between mb-2">
              <span className="capitalize font-medium text-ui-text-primary">{severity}</span>
              <span className="text-ui-text-tertiary">
                {getResolutionPercentage(severity as keyof typeof active).toFixed(1)}% Resolved
              </span>
            </div>
            <div className="h-2 bg-ui-divider rounded-full">
              <div
                className={`h-2 rounded-full ${
                  severity === 'critical'
                    ? 'bg-security-critical-text'
                    : severity === 'high'
                    ? 'bg-security-warning-text'
                    : severity === 'medium'
                    ? 'bg-security-warning-text'
                    : 'bg-security-info-text'
                }`}
                style={{
                  width: `${getResolutionPercentage(severity as keyof typeof active)}%`
                }}
              />
            </div>
          </div>
        ))}
      </div>
    </div>
  );
};

export default VulnerabilityDetailPanel; 